1. 数据库选择
同意：默认使用 SQLite，保留 MySQL 扩展支持
// 配置支持
type DBConfig struct {
    Driver   string `json:"driver"` // sqlite/mysql
    SQLitePath string `json:"sqlite_path"`
    MySQLDSN  string `json:"mysql_dsn"`
}


2. 上报去重策略
同意：以 serial 作为唯一主键，执行 Upsert 操作
func SaveServer(db *database.DB, server *Server) error {
    // 基于 serial 执行 INSERT OR REPLACE / ON DUPLICATE KEY UPDATE
    // 维护 created_at (仅新建时) 和 updated_at (总是更新)
}


3. 路由与认证
同意：补齐 REST 路由，启用 Bearer 认证中间件
// 路由规划
func SetupRouter(db *database.DB, cfg *config.Config) *gin.Engine {
    r := gin.Default()
    apiGroup := r.Group("/api")
    apiGroup.Use(auth.Middleware(cfg.AuthToken)) // Bearer 认证
    apiGroup.Use(rateLimit.Middleware())         // 速率限制
    
    apiGroup.POST("/report", handlers.ReportHandler(db))
    apiGroup.GET("/servers", handlers.ListServersHandler(db))
    apiGroup.GET("/servers/:serial", handlers.GetServerHandler(db))
    apiGroup.POST("/servers/:serial/confirm", handlers.ConfirmServerHandler(db))
    apiGroup.POST("/servers/:serial/install", handlers.MarkInstalledHandler(db))
    
    // 配置模板 CRUD
    apiGroup.GET("/configs", handlers.ListConfigsHandler(db))
    apiGroup.POST("/configs", handlers.CreateConfigHandler(db))
    apiGroup.PUT("/configs/:id", handlers.UpdateConfigHandler(db))
    apiGroup.POST("/configs/:id/apply", handlers.ApplyConfigHandler(db))
    
    return r
}


4. 字段命名规范
同意：统一为小驼峰格式
type Server struct {
    Serial        string `json:"serial"`
    Hostname      string `json:"hostname"`
    IPAddress     string `json:"ipAddress"`
    MACAddress    string `json:"macAddress"`
    Gateway       string `json:"gateway"`
    InstallTime   string `json:"installTime"`
    SdaSize       string `json:"sdaSize"`
    Part          string `json:"part"`
    SystemVersion string `json:"systemVersion"`
    KernelVersion string `json:"kernelVersion"`
    CPUModel      string `json:"cpuModel"`
    CPUProcessor  int    `json:"cpuProcessor"`
    MemTotal      int    `json:"memTotal"`
    MemoryNum     int    `json:"memoryNum"`
    LanNic        string `json:"lanNic"`
    LanNicSpeed   string `json:"lanNicSpeed"`
    WanNic        string `json:"wanNic"`
    WanNicSpeed   string `json:"wanNicSpeed"`
    BondNic       string `json:"bondNic"`
    BondNicSpeed  string `json:"bondNicSpeed"`
    Status        string `json:"status"`
}


5. PXE配置生成
同意：按 MAC 地址生成 pxelinux.cfg 文件
func GeneratePXEConfig(macAddress string, config *ConfigTemplate) error {
    // 格式化MAC: 01-aa-bb-cc-dd-ee-ff
    formattedMAC := "01-" + strings.ReplaceAll(strings.ToLower(macAddress), ":", "-")
    configPath := filepath.Join(tftpRoot, "pxelinux.cfg", formattedMAC)
    
    // 生成PXE引导配置
    content := GeneratePXEContent(config)
    return os.WriteFile(configPath, []byte(content), 0644)
}

6. Web前端优先级
同意：先完善基础交互，后续迭代高级功能

第一版：基础CRUD + 错误处理 + 加载状态

第二版：分页 + 搜索 + 实时状态

第三版：权限分级 + WebSocket

7. Agent增强
同意：自动网卡探测 + 重试机制
# 改进的网卡探测
get_primary_interface() {
    # 方法1: 通过默认路由
    ip route show default | awk '/default/ {print $5}' | head -1
    # 方法2: 通过网络管理器
    nmcli -t -f DEVICE device status | head -1
    # 方法3: 遍历/sys/class/net
}

8. DHCP管理边界
同意：第一版不托管DHCP，仅生成配置
// 生成DHCP配置片段供外部集成
func GenerateDHCPConfig(servers []Server) string {
    // 为每个confirmed状态的服务器生成host记录
    // 返回配置内容，由管理员手动集成到现有DHCP服务
}

9. 状态流转规则
同意：第一版手动标记 installed，后续支持自动
// Web界面提供"标记为已安装"按钮
// 后续可通过Webhook接收装机完成通知



🚀 实施计划
第一阶段：核心功能（1-2周）
数据库与模型
统一字段命名规范
实现SQLite迁移脚本
创建必要索引
认证与路由
实现Bearer认证中间件
补齐所有API路由
添加基础速率限制
PXE服务集成
实现Kickstart/Preseed模板渲染
生成MAC绑定的PXE配置
TFTP文件分发


第二阶段：稳定性增强（1周）
Agent改进
智能网卡探测
超时重试机制
离线数据缓存
Web前端完善
错误处理与用户反馈
加载状态指示
基础表单验证


第三阶段：生产就绪（1周）
部署优化
跨平台构建脚本
systemd服务配置
结构化日志集成
安全加固
IP白名单支持
输入验证
CORS配置

📋 待交付物
代码文件结构更新
pxe-manager/
├── migrations/           # 数据库迁移脚本
│   └── 001_initial.sql
├── auth/
│   ├── middleware.go    # 认证中间件
│   └── ratelimit.go     # 速率限制
├── pxe/
│   ├── generator.go     # PXE配置生成
│   ├── kickstart.go     # CentOS模板
│   └── preseed.go       # Ubuntu模板
└── web/
    ├── static/js/app.js # 完善的前端交互
    └── templates/
        ├── editor.html  # 增强的编辑器
        └── servers.html # 服务器管理页

配置文件示例
{
  "server_address": ":8080",
  "database": {
    "driver": "sqlite",
    "sqlite_path": "./data/pxe.db"
  },
  "auth": {
    "token": "your-secure-token",
    "ip_whitelist": ["192.168.88.0/24"],
    "rate_limit": 100
  },
  "tftp": {
    "root": "/var/lib/tftpboot",
    "enable_uefi": true
  }
}


