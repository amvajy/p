1. æ•°æ®åº“é€‰æ‹©
åŒæ„ï¼šé»˜è®¤ä½¿ç”¨ SQLiteï¼Œä¿ç•™ MySQL æ‰©å±•æ”¯æŒ
// é…ç½®æ”¯æŒ
type DBConfig struct {
    Driver   string `json:"driver"` // sqlite/mysql
    SQLitePath string `json:"sqlite_path"`
    MySQLDSN  string `json:"mysql_dsn"`
}


2. ä¸ŠæŠ¥å»é‡ç­–ç•¥
åŒæ„ï¼šä»¥ serial ä½œä¸ºå”¯ä¸€ä¸»é”®ï¼Œæ‰§è¡Œ Upsert æ“ä½œ
func SaveServer(db *database.DB, server *Server) error {
    // åŸºäº serial æ‰§è¡Œ INSERT OR REPLACE / ON DUPLICATE KEY UPDATE
    // ç»´æŠ¤ created_at (ä»…æ–°å»ºæ—¶) å’Œ updated_at (æ€»æ˜¯æ›´æ–°)
}


3. è·¯ç”±ä¸è®¤è¯
åŒæ„ï¼šè¡¥é½ REST è·¯ç”±ï¼Œå¯ç”¨ Bearer è®¤è¯ä¸­é—´ä»¶
// è·¯ç”±è§„åˆ’
func SetupRouter(db *database.DB, cfg *config.Config) *gin.Engine {
    r := gin.Default()
    apiGroup := r.Group("/api")
    apiGroup.Use(auth.Middleware(cfg.AuthToken)) // Bearer è®¤è¯
    apiGroup.Use(rateLimit.Middleware())         // é€Ÿç‡é™åˆ¶
    
    apiGroup.POST("/report", handlers.ReportHandler(db))
    apiGroup.GET("/servers", handlers.ListServersHandler(db))
    apiGroup.GET("/servers/:serial", handlers.GetServerHandler(db))
    apiGroup.POST("/servers/:serial/confirm", handlers.ConfirmServerHandler(db))
    apiGroup.POST("/servers/:serial/install", handlers.MarkInstalledHandler(db))
    
    // é…ç½®æ¨¡æ¿ CRUD
    apiGroup.GET("/configs", handlers.ListConfigsHandler(db))
    apiGroup.POST("/configs", handlers.CreateConfigHandler(db))
    apiGroup.PUT("/configs/:id", handlers.UpdateConfigHandler(db))
    apiGroup.POST("/configs/:id/apply", handlers.ApplyConfigHandler(db))
    
    return r
}


4. å­—æ®µå‘½åè§„èŒƒ
åŒæ„ï¼šç»Ÿä¸€ä¸ºå°é©¼å³°æ ¼å¼
type Server struct {
    Serial        string `json:"serial"`
    Hostname      string `json:"hostname"`
    IPAddress     string `json:"ipAddress"`
    MACAddress    string `json:"macAddress"`
    Gateway       string `json:"gateway"`
    InstallTime   string `json:"installTime"`
    SdaSize       string `json:"sdaSize"`
    Part          string `json:"part"`
    SystemVersion string `json:"systemVersion"`
    KernelVersion string `json:"kernelVersion"`
    CPUModel      string `json:"cpuModel"`
    CPUProcessor  int    `json:"cpuProcessor"`
    MemTotal      int    `json:"memTotal"`
    MemoryNum     int    `json:"memoryNum"`
    LanNic        string `json:"lanNic"`
    LanNicSpeed   string `json:"lanNicSpeed"`
    WanNic        string `json:"wanNic"`
    WanNicSpeed   string `json:"wanNicSpeed"`
    BondNic       string `json:"bondNic"`
    BondNicSpeed  string `json:"bondNicSpeed"`
    Status        string `json:"status"`
}


5. PXEé…ç½®ç”Ÿæˆ
åŒæ„ï¼šæŒ‰ MAC åœ°å€ç”Ÿæˆ pxelinux.cfg æ–‡ä»¶
func GeneratePXEConfig(macAddress string, config *ConfigTemplate) error {
    // æ ¼å¼åŒ–MAC: 01-aa-bb-cc-dd-ee-ff
    formattedMAC := "01-" + strings.ReplaceAll(strings.ToLower(macAddress), ":", "-")
    configPath := filepath.Join(tftpRoot, "pxelinux.cfg", formattedMAC)
    
    // ç”ŸæˆPXEå¼•å¯¼é…ç½®
    content := GeneratePXEContent(config)
    return os.WriteFile(configPath, []byte(content), 0644)
}

6. Webå‰ç«¯ä¼˜å…ˆçº§
åŒæ„ï¼šå…ˆå®Œå–„åŸºç¡€äº¤äº’ï¼Œåç»­è¿­ä»£é«˜çº§åŠŸèƒ½

ç¬¬ä¸€ç‰ˆï¼šåŸºç¡€CRUD + é”™è¯¯å¤„ç† + åŠ è½½çŠ¶æ€

ç¬¬äºŒç‰ˆï¼šåˆ†é¡µ + æœç´¢ + å®æ—¶çŠ¶æ€

ç¬¬ä¸‰ç‰ˆï¼šæƒé™åˆ†çº§ + WebSocket

7. Agentå¢å¼º
åŒæ„ï¼šè‡ªåŠ¨ç½‘å¡æ¢æµ‹ + é‡è¯•æœºåˆ¶
# æ”¹è¿›çš„ç½‘å¡æ¢æµ‹
get_primary_interface() {
    # æ–¹æ³•1: é€šè¿‡é»˜è®¤è·¯ç”±
    ip route show default | awk '/default/ {print $5}' | head -1
    # æ–¹æ³•2: é€šè¿‡ç½‘ç»œç®¡ç†å™¨
    nmcli -t -f DEVICE device status | head -1
    # æ–¹æ³•3: éå†/sys/class/net
}

8. DHCPç®¡ç†è¾¹ç•Œ
åŒæ„ï¼šç¬¬ä¸€ç‰ˆä¸æ‰˜ç®¡DHCPï¼Œä»…ç”Ÿæˆé…ç½®
// ç”ŸæˆDHCPé…ç½®ç‰‡æ®µä¾›å¤–éƒ¨é›†æˆ
func GenerateDHCPConfig(servers []Server) string {
    // ä¸ºæ¯ä¸ªconfirmedçŠ¶æ€çš„æœåŠ¡å™¨ç”Ÿæˆhostè®°å½•
    // è¿”å›é…ç½®å†…å®¹ï¼Œç”±ç®¡ç†å‘˜æ‰‹åŠ¨é›†æˆåˆ°ç°æœ‰DHCPæœåŠ¡
}

9. çŠ¶æ€æµè½¬è§„åˆ™
åŒæ„ï¼šç¬¬ä¸€ç‰ˆæ‰‹åŠ¨æ ‡è®° installedï¼Œåç»­æ”¯æŒè‡ªåŠ¨
// Webç•Œé¢æä¾›"æ ‡è®°ä¸ºå·²å®‰è£…"æŒ‰é’®
// åç»­å¯é€šè¿‡Webhookæ¥æ”¶è£…æœºå®Œæˆé€šçŸ¥



ğŸš€ å®æ–½è®¡åˆ’
ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2å‘¨ï¼‰
æ•°æ®åº“ä¸æ¨¡å‹
ç»Ÿä¸€å­—æ®µå‘½åè§„èŒƒ
å®ç°SQLiteè¿ç§»è„šæœ¬
åˆ›å»ºå¿…è¦ç´¢å¼•
è®¤è¯ä¸è·¯ç”±
å®ç°Bearerè®¤è¯ä¸­é—´ä»¶
è¡¥é½æ‰€æœ‰APIè·¯ç”±
æ·»åŠ åŸºç¡€é€Ÿç‡é™åˆ¶
PXEæœåŠ¡é›†æˆ
å®ç°Kickstart/Preseedæ¨¡æ¿æ¸²æŸ“
ç”ŸæˆMACç»‘å®šçš„PXEé…ç½®
TFTPæ–‡ä»¶åˆ†å‘


ç¬¬äºŒé˜¶æ®µï¼šç¨³å®šæ€§å¢å¼ºï¼ˆ1å‘¨ï¼‰
Agentæ”¹è¿›
æ™ºèƒ½ç½‘å¡æ¢æµ‹
è¶…æ—¶é‡è¯•æœºåˆ¶
ç¦»çº¿æ•°æ®ç¼“å­˜
Webå‰ç«¯å®Œå–„
é”™è¯¯å¤„ç†ä¸ç”¨æˆ·åé¦ˆ
åŠ è½½çŠ¶æ€æŒ‡ç¤º
åŸºç¡€è¡¨å•éªŒè¯


ç¬¬ä¸‰é˜¶æ®µï¼šç”Ÿäº§å°±ç»ªï¼ˆ1å‘¨ï¼‰
éƒ¨ç½²ä¼˜åŒ–
è·¨å¹³å°æ„å»ºè„šæœ¬
systemdæœåŠ¡é…ç½®
ç»“æ„åŒ–æ—¥å¿—é›†æˆ
å®‰å…¨åŠ å›º
IPç™½åå•æ”¯æŒ
è¾“å…¥éªŒè¯
CORSé…ç½®

ğŸ“‹ å¾…äº¤ä»˜ç‰©
ä»£ç æ–‡ä»¶ç»“æ„æ›´æ–°
pxe-manager/
â”œâ”€â”€ migrations/           # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚   â””â”€â”€ 001_initial.sql
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ middleware.go    # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ ratelimit.go     # é€Ÿç‡é™åˆ¶
â”œâ”€â”€ pxe/
â”‚   â”œâ”€â”€ generator.go     # PXEé…ç½®ç”Ÿæˆ
â”‚   â”œâ”€â”€ kickstart.go     # CentOSæ¨¡æ¿
â”‚   â””â”€â”€ preseed.go       # Ubuntuæ¨¡æ¿
â””â”€â”€ web/
    â”œâ”€â”€ static/js/app.js # å®Œå–„çš„å‰ç«¯äº¤äº’
    â””â”€â”€ templates/
        â”œâ”€â”€ editor.html  # å¢å¼ºçš„ç¼–è¾‘å™¨
        â””â”€â”€ servers.html # æœåŠ¡å™¨ç®¡ç†é¡µ

é…ç½®æ–‡ä»¶ç¤ºä¾‹
{
  "server_address": ":8080",
  "database": {
    "driver": "sqlite",
    "sqlite_path": "./data/pxe.db"
  },
  "auth": {
    "token": "your-secure-token",
    "ip_whitelist": ["192.168.88.0/24"],
    "rate_limit": 100
  },
  "tftp": {
    "root": "/var/lib/tftpboot",
    "enable_uefi": true
  }
}


